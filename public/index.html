<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Financial Upload Dashboard</title>
  <link rel="stylesheet" href="index.css">

</head>
<body>
  <h1>Financial Data Upload</h1>

  <div class="card">
    <form id="uploadForm">
      <label>User ID:</label>
      <input type="number" id="userId" value="1" min="1" required />

      <label>Year:</label>
      <input type="number" id="year" value="2025" min="1900" required />

      <label>Select Excel file (.xlsx) with columns: Month, Amount</label>
      <input type="file" id="fileInput" accept=".xls,.xlsx" required />

      <button type="submit"> Upload</button>
      <div id="status"></div>
    </form>
  </div>

  <div id="result" style="display:none;">
    <div class="card">
      <h2 id="userTitle"></h2>
      <canvas id="chart" width="800" height="300"></canvas>
      <table id="recordsTable">
        <thead><tr><th>Month</th><th>Amount</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const status = document.getElementById('status');
    const resultDiv = document.getElementById('result');
    const userTitle = document.getElementById('userTitle');
    const tableBody = document.querySelector('#recordsTable tbody');
    const ctx = document.getElementById('chart').getContext('2d');
    let chart = null;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      status.textContent = '';
      resultDiv.style.display = 'none';

      const userId = document.getElementById('userId').value;
      const year = document.getElementById('year').value;
      const file = fileInput.files[0];
      if (!file) {
        status.innerHTML = '<div class="error">⚠️ Please select a file</div>';
        return;
      }

      const fd = new FormData();
      fd.append('file', file, file.name);

      try {
        status.textContent = 'Uploading...';
        const res = await fetch(`/api/finances/upload/${userId}/${year}`, {
          method: 'POST',
          body: fd
        });
        const json = await res.json();
        if (!res.ok) {
          status.innerHTML = '<div class="error">'+(json.error || 'Upload failed')+'</div>';
          return;
        }
        status.textContent = json.message || '✅ Upload successful';
        await fetchAndDisplay(userId, year);
      } catch (err) {
        console.error(err);
        status.innerHTML = '<div class="error">Network/server error</div>';
      }
    });

    async function fetchAndDisplay(userId, year) {
      try {
        status.textContent = 'Fetching saved data...';
        const res = await fetch(`/api/finances/${userId}/${year}`);
        const json = await res.json();
        if (!res.ok) {
          status.innerHTML = '<div class="error">'+(json.error || 'Failed to fetch')+'</div>';
          return;
        }
        status.textContent = '';
        resultDiv.style.display = 'block';
        userTitle.textContent = json.user.name + ' — ' + json.year;

        const recs = json.records || [];
        const order = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        const map = new Map();
        recs.forEach(r => map.set(r.month, Number(r.amount)));

        const labels = order;
        const data = labels.map(m => map.has(m) ? map.get(m) : 0);

        tableBody.innerHTML = '';
        for (const m of labels) {
          const val = map.has(m) ? map.get(m) : '';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${m}</td><td>${val === '' ? '' : val.toFixed(2)}</td>`;
          tableBody.appendChild(tr);
        }

        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Amount',
              data,
              backgroundColor: labels.map(() => "rgba(122,79,246,0.8)"),
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true }
            },
            plugins: {
              legend: { display: false }
            }
          }
        });
      } catch (err) {
        console.error(err);
        status.innerHTML = '<div class="error">Error fetching data</div>';
      }
    }
  </script>
</body>
</html>
